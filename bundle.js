(()=>{"use strict";window.util={KeyboardKeyName:{ESCAPE:"Escape",ENTER:"Enter"},setDebounce:e=>{let t=null;return(...r)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...r)}),500)}}},(()=>{const e="GET",t="POST",r="https://21.javascript.pages.academy/kekstagram/data",n="https://21.javascript.pages.academy/kekstagram",o={400:"Ошибка в запросе",404:"Запрашиваемые данные не найдены",500:"Сервер не может обработать запрос"},s=(e,t)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{let n;switch(r.status){case 200:e(r.response);break;case 400:n=o[400];break;case 404:n=o[404];break;case 500:n=o[500];break;default:n=`Статус ответа: ${r.status} ${r.statusText}`}n&&t(n)})),r.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${r.timeout}мс`)})),r.timeout=1e4,r};window.backend={loadData:(t,n)=>{const o=s(t,n);o.open(e,r),o.send()},saveData:(e,r,o)=>{const l=s(e,r);l.open(t,n),l.send(o)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error");let n=null,o=null;const s=(t,r)=>{const s=t.cloneNode(!0),l=s.querySelector(".error__title"),d=document.createDocumentFragment();n=s.className,"error"===n&&(l.textContent=`${r}`),o=s.querySelector("button"),d.appendChild(s),e.appendChild(d),document.addEventListener("click",c,!0),document.addEventListener("keydown",i,!0),o.addEventListener("click",a,!0)},l=()=>{e.querySelector(`.${n}`).remove(),o.removeEventListener("click",a,!0),document.removeEventListener("click",c,!0),document.removeEventListener("keydown",i,!0),n=null,o=null},c=e=>{e.target.className===n&&l()},a=()=>{l()},i=e=>{e.key===window.util.KeyboardKeyName.ESCAPE&&(e.preventDefault(),l())};window.backendMessages={showSuccessMessage:()=>{s(t)},showErrorMessage:e=>{s(r,e)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comments"),r=t.querySelector(".social__comment"),n=e.querySelector(".big-picture__img img"),o=e.querySelector(".likes-count"),s=e.querySelector(".social__caption"),l=e.querySelector(".social__comment-count"),c=l.querySelector(".comments-count"),a=e.querySelector(".comments-loader"),i=e=>{let n=document.createDocumentFragment();for(let t=0;t<e.length;t++){const o=r.cloneNode(!0),{avatar:s,message:l,name:c}=e[t];o.querySelector(".social__picture").src=s,o.querySelector(".social__picture").alt=c,o.querySelector(".social__text").textContent=l,n.appendChild(o)}t.appendChild(n)};window.preview={showBigPicture:e=>{const{url:r,likes:d,description:u}=e;let{comments:m}=e,v=0;n.src=r,n.alt=u,o.textContent=`${d}`,c.textContent=`${m.length}`,s.textContent=u,(()=>{const e=t.querySelectorAll(".social__comment");for(let r=0;r<e.length;r++)t.removeChild(e[r])})();const y=()=>{m.length<=5?(v+=m.length,l.firstChild.textContent=`${v} из `,a.classList.add("hidden"),i(m),a.removeEventListener("click",y)):(v+=5,l.firstChild.textContent=`${v} из `,i(m.slice(0,5)),a.classList.remove("hidden"),m=m.slice(5))};y(),a.addEventListener("click",y)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector(".img-filters"),r=t.querySelector("#filter-default"),n=t.querySelector("#filter-random"),o=t.querySelector("#filter-discussed"),s=window.util.setDebounce((e=>{window.gallery.renderPictures(e)})),l=window.util.setDebounce((e=>{let t=[];for(let t=e.length-1;t>0;t--){let r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}for(let r=0;r<10;r++)t.push(e[r]);window.gallery.renderPictures(t)})),c=window.util.setDebounce((e=>{e.sort(((e,t)=>t.comments.length-e.comments.length)),window.gallery.renderPictures(e)})),a=(a,i)=>{a.target.className.includes("img-filters__button--active")||"BUTTON"!==a.target.nodeName||(t.querySelectorAll("button").forEach((e=>{e.classList.remove("img-filters__button--active")})),a.target.classList.add("img-filters__button--active"),e.querySelectorAll(".picture").forEach((e=>{e.remove()})),((e,t)=>{const a=Array.from(t);switch(e){case r:s(a);break;case n:l(a);break;case o:c(a)}})(a.target,i))};window.galleryFilters={setActionsOnFilters:e=>{t.classList.remove("img-filters--inactive"),t.addEventListener("click",(t=>{a(t,e)}),!0),t.addEventListener("keydown",(t=>{t.key===window.util.KeyboardKeyName.ENTER&&a(t,e)}),!0)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector(".big-picture"),r=t.querySelector(".big-picture__cancel"),n=e=>{const t=document.querySelector("#picture").content.querySelector(".picture").cloneNode(!0),{url:r,description:n,likes:o,comments:s}=e;return t.querySelector(".picture__img").src=r,t.querySelector(".picture__img").alt=n,t.querySelector(".picture__likes").textContent=`${o}`,t.querySelector(".picture__comments").textContent=`${s.length}`,t},o=e=>e.attributes[1].value.match(/\d+/)-1,s=e=>{document.body.classList.add("modal-open"),window.preview.showBigPicture(e),t.classList.remove("hidden"),r.addEventListener("click",a),document.addEventListener("keydown",c)},l=()=>{document.body.classList.remove("modal-open"),t.classList.add("hidden"),document.removeEventListener("keydown",c),r.removeEventListener("click",a)},c=e=>{e.key===window.util.KeyboardKeyName.ESCAPE&&(e.preventDefault(),l())},a=()=>{l()};window.gallery={renderPictures:t=>{const r=e,o=document.createDocumentFragment();for(let e=0;e<t.length;e++)o.appendChild(n(t[e]));r.appendChild(o)},setListenersOnLoadPictures:t=>{e.addEventListener("click",(e=>{((e,t)=>{if(e.target.classList.contains("picture__img")){const r=o(e.target);s(t[r])}})(e,t)}),!0),e.addEventListener("keydown",(e=>{((e,t)=>{if(e.key===window.util.KeyboardKeyName.ENTER&&e.target.classList.contains("picture")){e.preventDefault();const r=o(e.target.childNodes[1]);s(t[r])}})(e,t)}),!0)}}})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=e.querySelector(".img-upload__preview"),r=e.querySelector(".scale"),n=r.querySelector(".scale__control--value"),o=r.querySelector(".scale__control--smaller"),s=r.querySelector(".scale__control--bigger");window.uploadSize={imgSizeScaleClickHandler:e=>{const r=Number(n.value.match(/\d+/));e.target===o?(e=>{e>25&&(n.value=e-25+"%",t.style.transform=`scale(${(e-25)/100})`)})(r):e.target===s&&(e=>{e<100&&(n.value=`${e+25}%`,t.style.transform=`scale(${(e+25)/100})`)})(r)}}})(),(()=>{const e=document.querySelector("#upload-select-image"),t=e.querySelector(".img-upload__preview").querySelector("img"),r=e.querySelector(".effect-level"),n=r.querySelector(".effect-level__value"),o=r.querySelector(".effect-level__line"),s=o.querySelector(".effect-level__pin"),l=o.querySelector(".effect-level__depth");window.uploadEffects={effectListChangeHandler:e=>{e.target.matches('input[type="radio"]')&&(t.removeAttribute("class"),n.setAttribute("value","0"),s.style.left="0",l.style.width="0",t.style.filter="none","none"===e.target.attributes[4].value?r.classList.add("hidden"):(r.classList.remove("hidden"),t.classList.add(`effects__preview--${e.target.attributes[4].value}`)))},effectLevelPinMouseDownHandler:e=>{const r=parseInt(o.offsetWidth,10);let c=e.clientX;const a=e=>{e.preventDefault();let o=c-e.clientX,a=s.offsetLeft-o;c=e.clientX,a<0?a=0:a>r&&(a=r),s.style.left=`${a}px`,l.style.width=`${a}px`,n.setAttribute("value",`${Math.round(a/r*100)}`),(()=>{const e=t.getAttribute("class"),r=n.getAttribute("value");switch(e){case"effects__preview--chrome":t.style.filter=`grayscale(${r}%)`;break;case"effects__preview--sepia":t.style.filter=`sepia(${r}%)`;break;case"effects__preview--marvin":t.style.filter=`invert(${r}%)`;break;case"effects__preview--phobos":t.style.filter=`blur(${Math.floor(r/100*4)}px)`;break;case"effects__preview--heat":t.style.filter=`brightness(\n        ${r<33.333333333333336?1:Math.ceil(r/100*3)}\n        )`}})()},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)}}})(),(()=>{const e=/^#[\wа-яё]{1,19}$/,t=document.querySelector("#upload-select-image"),r=t.querySelector(".text__hashtags"),n=(e,t,r)=>{let n=!1;return-1!==r.indexOf(e,t+1)&&(n=!0),n},o=e=>{r.setCustomValidity(e),r.classList.add("invalid__text"),t.reportValidity()};window.validateHashtag={hashtagFieldInputHandler:()=>{const t=r.value.toLowerCase().trim().split(" ");r.classList.remove("invalid__text"),r.setCustomValidity(""),""!==r.value&&t.forEach((r=>"#"!==r[0]?o("Хэштег должен начинаться с символа #"):"#"===r?o("Хэштег не может состоять только из символа #"):r.length>20?o("Хэштег не может быть длиннее 20 символов"):e.test(r)?t.some(n)?o("Хэштеги не должны повторяться"):t.length>5?o("Хэштегов не может быть больше 5"):void 0:o("Хэштег не может содержать символы, пробелы и эмодзи")))}}})(),(()=>{const e=document.querySelector("#upload-select-image"),t=e.querySelector("#upload-file"),r=e.querySelector(".img-upload__overlay"),n=r.querySelector("#upload-cancel"),o=r.querySelector(".text__description"),s=r.querySelector(".text__hashtags"),l=e.querySelector(".effects__list"),c=l.querySelector("#effect-none"),a=r.querySelector(".img-upload__preview"),i=a.querySelector("img"),d=r.querySelector(".scale"),u=d.querySelector(".scale__control--value"),m=r.querySelector(".effect-level"),v=m.querySelector(".effect-level__line").querySelector(".effect-level__pin"),y=()=>{t.value="",e.reset(),r.classList.add("hidden"),document.body.classList.remove("modal-open"),u.value="100%",a.style.transform="none",i.style.filter="none",i.removeAttribute("class"),c.checked="true",s.classList.remove("invalid__text"),document.removeEventListener("keydown",w),d.removeEventListener("click",window.uploadSize.imgSizeScaleClickHandler),l.removeEventListener("change",window.uploadEffects.effectListChangeHandler,!0),v.removeEventListener("mousedown",window.uploadEffects.effectLevelPinMouseDownHandler),s.removeEventListener("input",window.validateHashtag.hashtagFieldInputHandler),e.removeEventListener("submit",f),n.removeEventListener("click",p)},w=e=>{e.key===window.util.KeyboardKeyName.ESCAPE&&document.activeElement!==s&&document.activeElement!==o&&(e.preventDefault(),y())},p=()=>{y()},f=t=>{t.preventDefault(),window.backend.saveData(window.backendMessages.showSuccessMessage,window.backendMessages.showErrorMessage,new FormData(e)),y()};t.addEventListener("change",(()=>{r.classList.remove("hidden"),document.body.classList.add("modal-open"),m.classList.add("hidden"),document.addEventListener("keydown",w),n.addEventListener("click",p),d.addEventListener("click",window.uploadSize.imgSizeScaleClickHandler),l.addEventListener("change",window.uploadEffects.effectListChangeHandler,!0),v.addEventListener("mousedown",window.uploadEffects.effectLevelPinMouseDownHandler),s.addEventListener("input",window.validateHashtag.hashtagFieldInputHandler),e.addEventListener("submit",f)}))})(),window.backend.loadData((e=>{window.gallery.renderPictures(e),window.gallery.setListenersOnLoadPictures(e),window.galleryFilters.setActionsOnFilters(e)}),(e=>{const t=document.createElement("div");t.classList.add("error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))})();